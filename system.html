<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>教案评分系统</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<style>
  .detail-content { white-space: pre-line; line-height:1.6; }
  .dimension-active { border-color:#165DFF; background:#eaf2ff; }
  .score-ok { color:#165DFF; font-weight:600; }
  .hidden { display:none; }
  .btn { transition:all .12s ease; }
  .btn:disabled { opacity:0.5; cursor:not-allowed; }
  .reason-box { border:1px solid #e5e7eb; padding:8px; border-radius:6px; }
  .reason-invalid { outline: 2px solid #fca5a5; }
  .small-muted { font-size: 12px; color: #6b7280; }
  body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
</style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <header class="bg-white shadow p-4">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center gap-3">
        <i class="fa fa-graduation-cap text-primary text-2xl" style="color:#165DFF"></i>
        <h1 class="text-lg font-bold">教案评分系统</h1>
      </div>
      <div class="text-sm text-gray-600">
        <span id="stats">当前：未加载教案 | 总数：0 份 | 已评分：0</span>
      </div>
    </div>
  </header>

  <main class="container mx-auto p-6">
    <div id="fallback-area" class="mb-4 p-3 border border-dashed rounded hidden">
      <p class="text-sm text-gray-600 mb-2">无法通过 fetch 读取本地文件。请选择本地文件作为回退：</p>
      <div class="space-y-2">
        <div>
          <label class="text-xs text-gray-700">教案 jsonl 文件（每行一个 JSON）：</label>
          <input type="file" id="file-jsonl" accept=".jsonl,.json,.txt" class="block mt-1" />
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-end">
          <div>
            <label class="text-xs text-gray-700">标准文件（可多选，支持通用 standard-1..5.txt）</label>
            <input type="file" id="files-standards" accept=".txt" multiple class="block mt-1" />
            <p class="text-xs text-gray-500 mt-1">
              推荐命名：
              <span class="small-muted">standard-1.txt ... standard-5.txt, standard-phy-1.txt, standard-che-2.txt ...</span>
            </p>
          </div>
          <div class="text-right">
            <button id="fallback-load" class="px-3 py-2 bg-blue-600 text-white rounded">加载选中文件</button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="bg-white rounded shadow p-4 lg:col-span-1">
        <h2 id="plan-name" class="text-lg font-semibold mb-2">（未加载）</h2>
        <div id="plan-meta" class="text-sm text-gray-600 mb-3"></div>

        <div class="mb-4">
          <h2 class="text-lg font-semibold mb-1">教案具体要求</h2> 
          <div class="bg-yellow-50 p-2 rounded detail-content text-sm text-gray-800" id="plan-query-detail">
            （无要求信息）
          </div>
        </div>
        
        <h2 class="text-lg font-semibold mb-2">教案内容</h2>
        <div class="bg-gray-50 p-3 rounded detail-content text-sm text-gray-800 max-h-[60vh] overflow-auto" id="plan-content">
          教案内容未加载。
        </div>

        <div class="mt-4 flex items-center justify-between text-sm text-gray-600">
          <div id="plan-index">当前：— / —</div>
          <div class="flex gap-2">
            <button id="prev-plan" class="px-3 py-1 border rounded btn" disabled><i class="fa fa-angle-left mr-1"></i> 上一份</button>
            <button id="next-plan" class="px-3 py-1 border rounded btn"><i class="fa fa-angle-right mr-1"></i> 下一份</button>
          </div>
        </div>
      </div>

      <div class="bg-white rounded shadow p-4 lg:col-span-2 flex flex-col">
        <div class="flex items-start justify-between mb-4">
          <div>
            <h3 class="text-lg font-semibold">评分维度</h3>
            <p class="text-sm text-gray-500">选择维度、输入分数与理由 → 完成所有维度后提交并下一份</p>
          </div>
          <div class="text-sm text-gray-600" id="dimension-progress">已完成 0 / 5</div>
        </div>

        <div class="flex gap-2 mb-4" id="dimension-buttons">
          <button class="dimension-btn px-3 py-2 border rounded dimension-active" data-dimension="1">结构完整性（满分10）</button>
          <button class="dimension-btn px-3 py-2 border rounded" data-dimension="2">内容准确性（满分14）</button>
          <button class="dimension-btn px-3 py-2 border rounded" data-dimension="3">内容一致性（满分2）</button>
          <button class="dimension-btn px-3 py-2 border rounded" data-dimension="4">语言逻辑性（满分2）</button>
          <button class="dimension-btn px-3 py-2 border rounded" data-dimension="5">素养导向性（满分2）</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 flex-1 overflow-auto">
          <div class="bg-gray-50 p-3 rounded h-full overflow-auto">
            <h4 class="font-medium mb-2">当前维度评分标准</h4>
            <div id="standard-area" class="text-sm text-gray-700 detail-content">标准加载中...</div>
          </div>

          <div class="p-3 rounded flex flex-col">
            <div class="mb-3">
              <h4 class="font-medium mb-2">选择分数（必填）</h4>
              <div class="flex items-center gap-3">
                <input id="score-input" type="number" min="0" step="1" class="w-28 p-2 border rounded" />
                <div class="text-sm text-gray-600" id="score-range">范围：0 - 10</div>
                <div id="score-ok-ind" class="ml-2 text-sm text-green-600 hidden">已选</div>
              </div>
            </div>

            <div class="mb-3 flex-1">
              <h4 class="font-medium mb-2">评分理由（必填）</h4>
              <div id="reason-container" class="space-y-2"></div>
            </div>

            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-600" id="current-dim-selected">当前维度：1</div>
              <div class="flex gap-2">
                <button id="save-dim" class="px-3 py-2 bg-green-600 text-white rounded btn">保存该维度</button>
                <button id="submit-next" class="px-4 py-2 bg-blue-600 text-white rounded btn" disabled>提交评分并下一份</button>
                <button id="export-current" class="px-3 py-2 border rounded btn" disabled title="导出当前教案的评分">导出当前</button>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4 flex items-center justify-between">
          <div class="text-sm text-gray-600" id="total-rule">总分规则：维度1 满分10，维度2 满分14，维度3/4/5 各满分2</div>
          <div class="flex gap-2">
            <button id="export-all" class="px-3 py-1.5 border rounded btn" disabled><i class="fa fa-download mr-1"></i> 导出全部</button>
            <button id="reload-data" class="px-3 py-1.5 border rounded btn">重新加载（尝试 fetch）</button>
          </div>
        </div>
      </div>
    </div>
  </main>

<script>
/* 严格修改标准加载和选择逻辑，以实现维度 1/2 的物理/化学学科特定标准。 */

const STORAGE_KEY_SCORED = 'teaching_scored_v1';
const STORAGE_KEY_INDEX = 'teaching_index_v1';
const STORAGE_KEY_CURRENT_SEL = 'teaching_current_sel_v1';

// default base max values (used when not math/phy/che)
const DEFAULT_MAXS = {1:10, 2:14, 3:2, 4:2, 5:2};
const MIN_REASON_LEN = 15;

const state = {
  plans: [],
  idx: 0,
  standards: {},
  // **新增：存储学科特定标准**
  subjectStandards: {}, 
  currentSelections: {},
  scored: {}
};

// DOM refs (保持不变)
const fallbackArea = document.getElementById('fallback-area');
const fileJsonlInput = document.getElementById('file-jsonl');
const filesStandardsInput = document.getElementById('files-standards');
const fallbackLoadBtn = document.getElementById('fallback-load');

const planName = document.getElementById('plan-name');
const planMeta = document.getElementById('plan-meta');
const planContent = document.getElementById('plan-content');
const planQueryDetail = document.getElementById('plan-query-detail'); 
const planIndex = document.getElementById('plan-index');
const statsEl = document.getElementById('stats');

const dimensionBtns = document.querySelectorAll('.dimension-btn');
const standardArea = document.getElementById('standard-area');
const scoreInput = document.getElementById('score-input');
const scoreRange = document.getElementById('score-range');
const scoreOkInd = document.getElementById('score-ok-ind');
const reasonContainer = document.getElementById('reason-container');
const currentDimSelected = document.getElementById('current-dim-selected');

const saveDimBtn = document.getElementById('save-dim');
const submitNextBtn = document.getElementById('submit-next');
const prevPlanBtn = document.getElementById('prev-plan');
const nextPlanBtn = document.getElementById('next-plan');
const exportCurrentBtn = document.getElementById('export-current');
const exportAllBtn = document.getElementById('export-all');
const reloadBtn = document.getElementById('reload-data');
const dimensionProgressEl = document.getElementById('dimension-progress');
const totalRuleEl = document.getElementById('total-rule');

let currentDim = 1;

// ---------- Helpers: subject normalization & checks (修改以支持 phy/che/math) ----------
function normalizeSubject(s) {
  if (!s) return '';
  const str = String(s).toLowerCase();
  if (/物理|physics|phys|phy/.test(str)) return 'phy';
  if (/化学|chemistry|chem|che/.test(str)) return 'che';
  if (/数学|math|mathematics/.test(str)) return 'math';
  return 'default'; // 统一返回默认
}
function isPhysics(subject) { return normalizeSubject(subject) === 'phy'; }
function isChemistry(subject) { return normalizeSubject(subject) === 'che'; }
function isMath(subject) { return normalizeSubject(subject) === 'math'; }

// ---------- 动态获取满分 (保持不变) ----------
function getMaxForDim(subject, dim) {
  const s = normalizeSubject(subject);
  if (dim === 1) {
    if (isMath(s)) return 9;
    // physics/chemistry and default use 10
    return DEFAULT_MAXS[1];
  }
  if (dim === 2) {
    if (isMath(s)) return 11;
    // physics/chemistry and default use 14
    return DEFAULT_MAXS[2];
  }
  return DEFAULT_MAXS[dim] || 2;
}

// ---------- parseJsonl (保持不变) ----------
function parseJsonl(text) {
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const parsed = [];
  lines.forEach((ln,i) => {
    try {
      const obj = JSON.parse(ln);
      // 提取教案名称（query中“教案：”后的部分）和具体要求
      let query = (obj.query || '').toString().trim();
      let planName = obj.name ?? obj.title ?? `教案 ${i+1}`;
      let detail = '';

      if (query) {
        // 尝试从 query 中提取教案名称
        const nameMatch = query.match(/教案[：:]([^，,。]+)/);
        if (nameMatch && nameMatch[1]) {
           planName = nameMatch[1].trim();
        }
        
        // 提取具体要求（将 query 中 "教案:XXX" 后的所有内容视为具体要求）
        let detailTemp = query.replace(/教案[：:].*?[\s，,。]*/, '').trim();
        if (detailTemp.startsWith('要包含')) {
             detail = detailTemp;
        } else if (detailTemp) {
             // 如果内容不以“要包含”开头，但存在，也将其视为要求
             detail = detailTemp;
        }
      }

      parsed.push({
        id: obj.id ?? `p${i+1}`,
        name: planName,
        subject: (obj.subject ?? obj.category ?? '').toString(),
        category: obj.category ?? '',
        grade: obj.grade ?? null,
        teacher: obj.teacher ?? '',
        queryDetail: detail, // 新增：教案的具体要求
        content: (obj.content ?? obj.answer ?? obj.text ?? '').toString()
      });
    } catch (e) {
      console.warn('jsonl 行解析出错，跳过：', i, e);
    }
  });
  state.plans = parsed;
}

// ---------- 核心修改: 选择标准文本 - 优先学科标准（仅 dim 1 & 2） ----------
function chooseStandardTextForDim(dim, subject) {
  const subjKey = normalizeSubject(subject);
  
  // 1. 检查是否为学科标准适用维度 (1 或 2)
  if (dim === 1 || dim === 2) {
      // 检查当前教案的科目是否有特定标准
      if ((isPhysics(subjKey) || isChemistry(subjKey)) && state.subjectStandards[subjKey] && state.subjectStandards[subjKey][dim]) {
          return state.subjectStandards[subjKey][dim];
      }
      // 检查数学科目 (虽然要求只针对物理化学，但如果存在数学标准，也应该兼容)
      if (isMath(subjKey) && state.subjectStandards[subjKey] && state.subjectStandards[subjKey][dim]) {
          return state.subjectStandards[subjKey][dim];
      }
  }

  // 2. 回退到通用标准 (包括 dim 3, 4, 5 以及没有特定标准的学科/维度)
  return state.standards[dim] || `（维度 ${dim} 标准未找到）`;
}

// ---------- 根据学科与维度返回理由数量 (保持不变) ----------
function getReasonCountForDim(subject, dim) {
  const s = normalizeSubject(subject);
  if (dim === 1) {
    if (isPhysics(s) || isChemistry(s)) return 5;
    if (isMath(s)) return 4;
    return 5;
  }
  if (dim === 2) {
    if (isPhysics(s) || isChemistry(s)) return 6;
    if (isMath(s)) return 5;
    return 5;
  }
  return 1;
}

// ---------- localStorage helpers (保持不变) ----------
function saveToLocalStorage(){
  try {
    localStorage.setItem(STORAGE_KEY_SCORED, JSON.stringify(state.scored));
    localStorage.setItem(STORAGE_KEY_INDEX, String(state.idx));
    const mapping = JSON.parse(localStorage.getItem(STORAGE_KEY_CURRENT_SEL) || '{}');
    const pid = state.plans[state.idx]?.id;
    if (pid) mapping[pid] = state.currentSelections;
    localStorage.setItem(STORAGE_KEY_CURRENT_SEL, JSON.stringify(mapping));
  } catch (e) { console.warn('localStorage save failed', e); }
}
function loadFromLocalStorage(){
  try {
    const scoredRaw = localStorage.getItem(STORAGE_KEY_SCORED);
    if (scoredRaw) state.scored = JSON.parse(scoredRaw);
    const idxRaw = localStorage.getItem(STORAGE_KEY_INDEX);
    if (idxRaw) state.idx = Number(idxRaw) || 0;
  } catch (e) { console.warn('localStorage load failed', e); }
}

// ---------- 核心修改: tryFetchAll - 尝试加载所有标准文件（包括物理/化学学科标准） ----------
async function tryFetchAll() {
  // 定义需要加载的学科前缀和维度
  const subjectsToLoad = { 'phy': 'standard-phy-', 'che': 'standard-che-', 'math': 'standard-math-' }; // 保持兼容性，但重点是 phy/che
  const dimsToLoad = [1, 2];
  let standardLoaded = false;
  
  // 1. 尝试加载通用标准 (Dim 1-5)
  for (let i=1;i<=5;i++){
    try {
      const r = await fetch(`standard-${i}.txt`);
      if (r.ok) { state.standards[i] = await r.text(); standardLoaded = true; }
    } catch(e){}
  }

  // 2. 尝试加载学科特定标准 (仅 Dim 1 & 2)
  for (const subjKey in subjectsToLoad) {
    state.subjectStandards[subjKey] = state.subjectStandards[subjKey] || {};
    for (const dim of dimsToLoad){
        try {
            const r = await fetch(`${subjectsToLoad[subjKey]}${dim}.text`);
            if (r.ok) { state.subjectStandards[subjKey][dim] = await r.text(); standardLoaded = true; }
        } catch(e){}
    }
  }

  // 3. 尝试加载教案数据 (假设文件名是 teaching-plans.jsonl)
  try {
    const r2 = await fetch('math.jsonl'); // 沿用原代码中的文件名
    if (!r2.ok) throw new Error('jsonl 缺失');
    const txt = await r2.text();
    parseJsonl(txt);
    
    // 使用新的选择逻辑来初始化标准区域
    standardArea.innerText = chooseStandardTextForDim(1, state.plans[0]?.subject) || '（无标准）';
    return true;
  } catch (e) {
    console.warn('fetch 数据失败：', e);
    // 即使教案加载失败，如果标准文件加载了，也显示第一个维度标准
    if (standardLoaded) standardArea.innerText = chooseStandardTextForDim(1, null) || '（无标准）';
    return false;
  }
}

// ---------- 核心修改: fallbackLoad - 解析本地上传的标准文件（识别学科） ----------
fallbackLoadBtn.addEventListener('click', ()=> {
  const stdFiles = Array.from(filesStandardsInput.files || []);
  stdFiles.forEach(f => {
    const name = f.name.toLowerCase();
    const reader = new FileReader();
    reader.onload = (ev) => {
      const text = ev.target.result;
      // 匹配 standard-[subj]-[dim].txt (如 standard-phy-1.txt) 或 standard-[dim].txt
      const m = name.match(/standard[-_](?:(phy|che|math)[-_])?(\d)\.txt/);
      
      if (m) {
        const subjCode = m[1]; // 'phy', 'che', 'math' 或 undefined
        const dim = Number(m[2]); // 1, 2, 3, 4, 5
        
        // 只存储维度 1/2 的学科标准
        if (subjCode && (dim === 1 || dim === 2)) {
            state.subjectStandards[subjCode] = state.subjectStandards[subjCode] || {};
            state.subjectStandards[subjCode][dim] = text;
        } 
        // 存储通用标准
        else if (!subjCode && dim >= 1 && dim <= 5) {
            state.standards[dim] = text;
        } else if (dim >= 1 && dim <= 5) {
             // 如果是维度 3/4/5 的学科文件，也作为通用标准存储，防止通用标准缺失
            state.standards[dim] = text;
        } else {
             // 忽略不规范文件
            console.warn(`忽略文件 ${name}：文件名格式不符合预期。`);
        }
      } else {
        // 尝试匹配 standardN.txt (如 standard1.txt)
        const m2 = name.match(/standard[-_]?(\d)/);
        if (m2 && m2[1]) {
            const dim = Number(m2[1]);
            if (dim >= 1 && dim <= 5) state.standards[dim] = text;
        } else {
            // 文件名不规范，尝试填补通用的空位
            for (let k = 1; k <= 5; k++) {
              if (!state.standards[k]) { state.standards[k] = text; break; }
            }
        }
      }

      standardArea.innerText = chooseStandardTextForDim(currentDim, state.plans[state.idx]?.subject) || state.standards[currentDim] || '（无标准）';
    };
    reader.readAsText(f);
  });

  const jf = fileJsonlInput.files && fileJsonlInput.files[0];
  if (!jf) { alert('请先选择 teaching-plans.jsonl 文件'); return; }
  const reader = new FileReader();
  reader.onload = (ev) => {
    parseJsonl(ev.target.result);
    fallbackArea.classList.add('hidden');
    if (state.plans.length) { 
        state.idx = 0; 
        renderPlan(0); 
        updateStats(); 
        alert('已加载本地教案（回退）'); 
    }
    else alert('未解析到任何教案，请检查 jsonl 格式');
  };
  reader.readAsText(jf);
});

// ---------- renderPlan (使用新的标准获取逻辑) ----------
function renderPlan(idx) {
  if (!state.plans.length) {
    planName.innerText = '未加载教案';
    planContent.innerText = '请加载 teaching-plans.jsonl';
    planMeta.innerHTML = '';
    planQueryDetail.innerText = '（无要求信息）'; 
    return;
  }
  if (idx < 0) idx = 0;
  if (idx >= state.plans.length) idx = state.plans.length - 1;
  state.idx = idx;
  const p = state.plans[idx];
  planName.innerText = p.name || `教案 ${idx+1}`;
  const parts = [];
  if (p.subject) parts.push(p.subject);
  if (p.grade) parts.push(p.grade);
  if (p.teacher) parts.push(p.teacher);
  planMeta.innerText = parts.join(' · ');
  planContent.innerText = p.content || '（无正文）';
  planQueryDetail.innerText = p.queryDetail || '（无要求信息）'; // 显示具体要求
  planIndex.innerText = `当前：${idx+1} / ${state.plans.length}`;

  // restore currentSelections from mapping if present
  try {
    const mappingRaw = localStorage.getItem(STORAGE_KEY_CURRENT_SEL);
    if (mappingRaw) {
      const map = JSON.parse(mappingRaw);
      const pid = p.id;
      if (pid && map[pid]) state.currentSelections = map[pid];
      else if (state.scored[p.id]) state.currentSelections = JSON.parse(JSON.stringify(state.scored[p.id].scores));
      else state.currentSelections = {};
    } else if (state.scored[p.id]) state.currentSelections = JSON.parse(JSON.stringify(state.scored[p.id].scores));
    else state.currentSelections = {};
  } catch(e){ state.currentSelections = {}; }

  // update dimension button labels according to subject
  updateDimensionButtonLabels(p.subject);

  // update standard area for current dimension and subject
  // !!! 使用新的 chooseStandardTextForDim 来获取正确的标准 !!!
  standardArea.innerText = chooseStandardTextForDim(currentDim, p.subject) || state.standards[currentDim] || '（无标准）';

  setCurrentDimension(currentDim || 1);
  updateDimensionProgress();
  updateStats();
  prevPlanBtn.disabled = idx <= 0;
  nextPlanBtn.disabled = idx >= state.plans.length - 1;
  exportCurrentBtn.disabled = !(p && state.scored[p.id]);
  exportAllBtn.disabled = Object.keys(state.scored).length === 0;
}

// ---------- 更新维度按钮文本以显示满分 (保持不变) ----------
function updateDimensionButtonLabels(subject) {
  const names = ['结构完整性','内容准确性','内容一致性','语言逻辑性','素养导向性'];
  dimensionBtns.forEach((btn, i) => {
    const dim = i+1;
    const max = getMaxForDim(subject, dim);
    btn.innerText = `${names[i]}（满分${max}）`;
  });
  // update displayed total rule text
  const max1 = getMaxForDim(subject,1);
  const max2 = getMaxForDim(subject,2);
  totalRuleEl.innerText = `总分规则：维度1 满分${max1}，维度2 满分${max2}，维度3/4/5 各满分2`;
}

// ---------- stats (保持不变) ----------
function updateStats(){
  statsEl.innerText = `当前：${state.plans[state.idx]?.name ?? '未加载'} | 总数：${state.plans.length} 份 | 已评分：${Object.keys(state.scored).length}`;
  document.getElementById('dimension-progress').innerText = `已完成 ${countDoneDims()} / 5`;
}

// ---------- dimension UI - setCurrentDimension (使用新的标准获取逻辑) ----------
dimensionBtns.forEach(b => b.addEventListener('click', ()=> setCurrentDimension(Number(b.dataset.dimension))));

function setCurrentDimension(dim) {
  currentDim = dim;
  state.currentDimension = dim;
  dimensionBtns.forEach(b => b.classList.toggle('dimension-active', Number(b.dataset.dimension) === dim));
  const p = state.plans[state.idx];
  // !!! 使用新的 chooseStandardTextForDim 来获取正确的标准 !!!
  standardArea.innerText = chooseStandardTextForDim(dim, p?.subject) || state.standards[dim] || '（无标准）';

  // dynamic max for current plan's subject
  const subj = p?.subject;
  const maxForDim = getMaxForDim(subj, dim);
  scoreInput.min = 0;
  scoreInput.max = maxForDim;
  scoreRange.innerText = `范围：0 - ${maxForDim}`;

  renderReasonInputsForDim(dim);
  const cur = state.currentSelections[dim] || null;
  if (cur && typeof cur.score === 'number') {
    scoreInput.value = cur.score;
    scoreOkInd.classList.remove('hidden');
    scoreOkInd.innerText = '已选';
  } else {
    scoreInput.value = '';
    scoreOkInd.classList.add('hidden');
  }
  fillReasonInputs(cur);
  currentDimSelected.innerText = `当前维度：${dim}`;
  updateSubmitButtonState();
}

function renderReasonInputsForDim(dim){
  reasonContainer.innerHTML = '';
  const p = state.plans[state.idx] || {};
  const subject = p.subject || p.category || '';
  const count = getReasonCountForDim(subject, dim);

  if (count > 1) {
    for (let i=0;i<count;i++){
      const wrapper = document.createElement('div');
      wrapper.className = 'reason-box';
      const prefix = `${dim}.${i+1}`;
      // *** 新增：在每个评分理由上方增加一个简易打分栏 ***
      wrapper.innerHTML = `
        <div class="flex items-center justify-between mb-2">
            <label class="text-xs text-gray-600 font-bold">${prefix} 评分理由</label>
            <div class="flex items-center gap-1">
                <span class="text-xs text-gray-500">打分:</span>
                <input type="number" class="w-16 p-1 text-xs border rounded sub-score-input" data-idx="${i}" placeholder="分数" />
            </div>
        </div>
        <textarea class="w-full p-2 mt-1 reason-field" data-idx="${i}" rows="3" placeholder="请输入至少${MIN_REASON_LEN}个字的理由（必填）"></textarea>
      `;
      reasonContainer.appendChild(wrapper);
    }
  } else {
    const wrapper = document.createElement('div');
    wrapper.className = 'reason-box';
    wrapper.innerHTML = `
      <label class="text-xs text-gray-600">评分理由（至少${MIN_REASON_LEN}字）</label>
      <textarea id="single-reason" class="w-full p-2 mt-1" rows="6" placeholder="请输入至少${MIN_REASON_LEN}个字的评分理由（必填）"></textarea>
    `;
    reasonContainer.appendChild(wrapper);
  }
}

function fillReasonInputs(cur){
  if (!cur) {
    if (currentDim===1 || currentDim===2) {
        document.querySelectorAll('.reason-field').forEach(tf=> tf.value = '');
        document.querySelectorAll('.sub-score-input').forEach(si=> si.value = '');
    }
    else { const s = document.getElementById('single-reason'); if (s) s.value = ''; }
    return;
  }
  if (currentDim===1 || currentDim===2) {
    const arr = Array.isArray(cur.reason) ? cur.reason : (String(cur.reason || '') ? [String(cur.reason)] : []);
    const subScoresArr = Array.isArray(cur.subScores) ? cur.subScores : [];
    document.querySelectorAll('.reason-field').forEach((tf, idx) => { tf.value = arr[idx] || ''; });
    // *** 新增：回显打分栏的分数 ***
    document.querySelectorAll('.sub-score-input').forEach((si, idx) => { si.value = subScoresArr[idx] || ''; });
  } else {
    const s = document.getElementById('single-reason');
    if (s) s.value = cur.reason || '';
  }
}

// ---------- save dimension (保持不变) ----------
saveDimBtn.addEventListener('click', () => {
  const sValRaw = scoreInput.value;
  const subj = state.plans[state.idx]?.subject;
  const maxAllowed = getMaxForDim(subj, currentDim);
  const sVal = sValRaw === '' ? null : Number(sValRaw);
  if (sVal === null || isNaN(sVal)) { alert('请填写当前维度的分数（数字）'); return; }
  if (sVal < 0 || sVal > maxAllowed) { alert(`分数范围不合法，请输入 0 到 ${maxAllowed} 的整数`); return; }

  if (currentDim === 1 || currentDim === 2) {
    const fields = Array.from(document.querySelectorAll('.reason-field'));
    const arr = fields.map(f => f.value.trim());
    
    // *** 新增：读取并存储每个理由上方的分数 ***
    const subScores = Array.from(document.querySelectorAll('.sub-score-input')).map(si => si.value);

    const invalidIdx = arr.findIndex(x => (x || '').length < MIN_REASON_LEN);
    if (invalidIdx !== -1) {
      alert(`第 ${invalidIdx+1} 个理由少于 ${MIN_REASON_LEN} 字，请补充。`);
      fields.forEach((f, i) => f.classList.toggle('reason-invalid', (arr[i]||'').length < MIN_REASON_LEN));
      return;
    }
    fields.forEach(f=> f.classList.remove('reason-invalid'));
    state.currentSelections[currentDim] = { score: sVal, reason: arr, subScores: subScores };
  } else {
    const s = document.getElementById('single-reason');
    const txt = s ? s.value.trim() : '';
    if (!txt || txt.length < MIN_REASON_LEN) { alert(`理由需至少 ${MIN_REASON_LEN} 字，请补充`); if (s) s.classList.add('reason-invalid'); return; }
    if (s) s.classList.remove('reason-invalid');
    state.currentSelections[currentDim] = { score: sVal, reason: txt };
  }

  scoreOkInd.classList.remove('hidden'); scoreOkInd.innerText = '已保存';
  updateDimensionProgress();
  updateSubmitButtonState();
  saveToLocalStorage();
  exportAllBtn.disabled = Object.keys(state.scored).length === 0;
});

// ---------- submit and next (保持不变) ----------
submitNextBtn.addEventListener('click', () => {
  for (let d=1; d<=5; d++){
    const v = state.currentSelections[d];
    if (!v || typeof v.score !== 'number') { alert('请先完成所有维度的评分并保存（每个维度都需保存）'); return; }
    if (d===1 || d===2) {
      const needed = getReasonCountForDim(state.plans[state.idx]?.subject, d);
      if (!Array.isArray(v.reason) || v.reason.length !== needed || v.reason.some(r => (r||'').length < MIN_REASON_LEN)) {
        alert(`维度 ${d} 的每个理由都必须至少 ${MIN_REASON_LEN} 个字，请检查并补全`);
        return;
      }
    } else {
      if (!(v.reason && String(v.reason).trim().length >= MIN_REASON_LEN)) {
        alert(`第 ${d} 个维度的理由需至少 ${MIN_REASON_LEN} 字，请补充`);
        return;
      }
    }
  }

  const p = state.plans[state.idx];
  const total = Number(state.currentSelections[1].score)
              + Number(state.currentSelections[2].score)
              + Number(state.currentSelections[3].score)
              + Number(state.currentSelections[4].score)
              + Number(state.currentSelections[5].score);
  state.scored[p.id] = {
    id: p.id,
    name: p.name,
    scores: JSON.parse(JSON.stringify(state.currentSelections)),
    total,
    time: new Date().toISOString()
  };

  saveToLocalStorage();
  state.currentSelections = {};
  if (state.idx < state.plans.length - 1) renderPlan(state.idx + 1);
  else { updateStats(); alert('已完成最后一份教案评分，评分已保存到本地（localStorage）。'); }
  updateStats();
  exportAllBtn.disabled = Object.keys(state.scored).length === 0;
});

// prev / next (保持不变)
prevPlanBtn.addEventListener('click', ()=> { if (state.idx > 0) renderPlan(state.idx - 1); });
nextPlanBtn.addEventListener('click', ()=> { if (state.idx < state.plans.length - 1) renderPlan(state.idx + 1); });

// ---------- helpers: progress (保持不变) ----------
function updateDimensionProgress(){ const done = countDoneDims(); dimensionProgressEl.innerText = `已完成 ${done} / 5`; document.getElementById('dimension-progress').innerText = `已完成 ${done} / 5`; }
function countDoneDims(){
  let c=0;
  for (let d=1; d<=5; d++){
    const v = state.currentSelections[d];
    if (v && typeof v.score === 'number') {
      if (d===1 || d===2) {
        const needed = getReasonCountForDim(state.plans[state.idx]?.subject, d);
        if (Array.isArray(v.reason) && v.reason.length===needed && v.reason.every(r=> (r||'').length>=MIN_REASON_LEN)) c++;
      } else {
        if (v.reason && String(v.reason).trim().length>=MIN_REASON_LEN) c++;
      }
    }
  }
  exportCurrentBtn.disabled = !(state.plans[state.idx] && state.scored[state.plans[state.idx].id]);
  exportAllBtn.disabled = Object.keys(state.scored).length === 0;
  return c;
}
function updateSubmitButtonState(){ const ready = countDoneDims() === 5; submitNextBtn.disabled = !ready; const p = state.plans[state.idx]; exportCurrentBtn.disabled = !(p && state.scored[p.id]); exportAllBtn.disabled = Object.keys(state.scored).length === 0; }

// ---------- export current / all (保持不变) ----------
exportCurrentBtn.addEventListener('click', () => {
  const p = state.plans[state.idx];
  if (!p) { alert('当前无教案'); return; }
  const entry = state.scored[p.id];
  if (!entry) { alert('当前教案尚未提交评分，无法导出'); return; }
  const blob = new Blob([JSON.stringify(entry, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = `${(entry.name||p.id).replace(/[\/\\]/g,'_')}_score_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
  a.click(); URL.revokeObjectURL(url);
});
exportAllBtn.addEventListener('click', () => {
  const arr = Object.values(state.scored);
  if (!arr.length) { alert('暂无评分数据可导出'); return; }
  const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = `all_scored_plans_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
  a.click(); URL.revokeObjectURL(url);
});

// ---------- reload / initial load (保持不变) ----------
reloadBtn.addEventListener('click', async () => {
  const ok = await tryFetchAll();
  if (ok) { fallbackArea.classList.add('hidden'); if (state.plans.length) renderPlan(0); alert('fetch 加载成功'); }
  else { fallbackArea.classList.remove('hidden'); alert('fetch 仍失败，请使用回退上传或启动本地静态服务器'); }
});

// initial (保持不变)
document.addEventListener('DOMContentLoaded', async () => {
  const ok = await tryFetchAll();
  loadFromLocalStorage();
  if (!ok) fallbackArea.classList.remove('hidden');
  if (state.plans.length) {
    if (state.idx < 0 || state.idx >= state.plans.length) state.idx = 0;
    renderPlan(state.idx);
  }
  updateStats();
  setCurrentDimension(1);
});

// helper escape (not used, but kept)
function escapeHtml(s){ return s?.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') || ''; }
</script>
</body>
</html>